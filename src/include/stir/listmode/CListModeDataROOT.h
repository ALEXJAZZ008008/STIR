/*
 *  Copyright (C) 2015, 2016 University of Leeds
    Copyright (C) 2016, UCL
    This file is part of STIR.

    This file is free software; you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation; either version 2.1 of the License, or
    (at your option) any later version.

    This file is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Lesser General Public License for more details.

    See STIR/LICENSE.txt for details
*/
/*!
  \file
  \ingroup listmode
  \brief Declaration of class stir::CListModeDataROOT

  \author Nikos Efthimiou
*/

#ifndef __stir_listmode_CListModeDataROOT_H__
#define __stir_listmode_CListModeDataROOT_H__

#include "stir/listmode/CListModeData.h"
#include "stir/listmode/CListRecordROOT.h"
#include "stir/IO/InputStreamFromROOTFile.h"
#include "stir/KeyParser.h"

START_NAMESPACE_STIR

//!
//! \brief The CListModeDataROOT class
//! \details A class that reads ROOT files, generated by GATE, as listmode data.
//! \author Nikos Efthimiou
//!
class CListModeDataROOT : public CListModeData
{
public:
    //! Construct fron the filename of the Interfile header
    CListModeDataROOT(const std::string& listmode_filename_prefix);

    virtual std::string
    get_name() const;

    virtual
    shared_ptr <CListRecord> get_empty_record_sptr() const;

    virtual
    Succeeded get_next_record(CListRecord& record) const;

    virtual
    Succeeded reset();

    virtual
    SavedPosition save_get_position();

    virtual
    Succeeded set_get_position(const SavedPosition&);

    virtual
    bool has_delayeds() const { return true; }

    virtual
    long long int
    get_total_number_of_events() const ;

private:
//    typedef CListRecordROOT CListRecordT;

    //! The header file, bad name choise.
    std::string listmode_filename;
    //! The root file
    std::string input_data_filename;
    //! Pointer to the listmode data
    shared_ptr<InputStreamFromROOTFile > current_lm_data_ptr;

    //! The name of the originating scanner
    std::string originating_system;
    int num_rings;
    int num_detectors_per_ring;
    int max_num_non_arccorrected_bins;
    float inner_ring_diameter;
    float average_depth_of_interaction;
    float ring_spacing;
    float bin_size;

    KeyParser parser;
    //! Name of input chain which is going to be used.
    std::string name_of_input_tchain;

    //!
    int singles_readout_depth;
    //! Number of the rsectors used in the GATE mac file
    int number_of_rsectors;
    //! The x axis would indicate mupliple layers
    int number_of_modules_x;
    //! The y axis indicates the tangestial position
    int number_of_modules_y;
    //! The z axis is the axial
    int number_of_modules_z;
    //! Number of submodules x in the GATE mac file
    int number_of_submodules_x;
    //! Submodule y repeater in the GATE mac file
    int number_of_submodules_y;
    //! Submodule z repeater in the GATE mac file
    int number_of_submodules_z;
    //! Crystal x repeater in the GATE mac file
    int number_of_crystals_x;
    //! Crystla y repeater in the GATE mac file
    int number_of_crystals_y;
    //! Crystal z repeater in the GATE mac file
    int number_of_crystals_z;
    //! Number of detectors to rotate, if the user has used default GATE
    //! geometry, first block in phi = 0, then this should be zero, to
    //! align with STIR.
    int offset_dets;

    //! Total number of events in the ROOT file
    long long int total_number_of_events;

    //! If set all scattered events will be excluded
    bool exclude_scattered;
    //! If set all random event will be excluded
    bool exclude_randoms;

    //! The low energy window threshold
    //! \warning When ExamData are merged it will be removed
    float low_energy_window;
    //! The upper energy window threshold
    //! \warning When ExamData are merged it will be removed
    float up_energy_window;
    //! Checks if the input file is indeed a root file, and opens it.
    Succeeded open_lm_file();
};


END_NAMESPACE_STIR

#endif
